# Implementation Plan: Phase 2 Authentication Rebuild

**Branch**: `002-todo-web-app` | **Date**: 2026-01-21 | **Spec**: [spec.md](./spec.md)
**Input**: Phase 2 Authentication specification - complete rebuild from scratch

## Summary

Rebuild the authentication system from scratch using FastAPI, SQLAlchemy, Passlib (bcrypt), and JWT. This replaces any existing auth code with a clean, production-ready implementation that supports:
- User registration with email/password (POST /api/auth/register)
- User login with JWT token (POST /api/auth/login)
- Get current user (GET /api/auth/me)

## Technical Context

**Language/Version**: Python 3.11+
**Primary Dependencies**: FastAPI, SQLAlchemy, Alembic, Passlib[bcrypt], python-jose
**Storage**: SQLite (development), PostgreSQL (production)
**Testing**: pytest with httpx TestClient
**Target Platform**: Linux/Windows server, Docker-ready
**Project Type**: Web application (frontend + backend monorepo)
**Performance Goals**: <200ms response time, 100 concurrent users
**Constraints**: No generic exception handling, explicit HTTP errors only
**Scale/Scope**: Single-service auth, ~5 endpoints, ~10 files

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Spec-Driven Development | ✅ PASS | Following spec → plan → tasks → impl |
| II. No Manual Coding | ✅ PASS | All code generated by Claude Code |
| III. Monorepo Architecture | ✅ PASS | Frontend + backend in single repo |
| IV. Clean, Secure Code | ✅ PASS | Using bcrypt, JWT, input validation |
| V. Separation of Concerns | ✅ PASS | API / Service / Model layers |
| VI. Persistent Storage | ✅ PASS | SQLite/PostgreSQL via SQLAlchemy |

**Gate Status**: ✅ ALL PASSED - Proceed to implementation

## Project Structure

### Documentation (this feature)

```text
specs/002-todo-web-app/
├── plan.md              # This file
├── research.md          # Phase 0 - Technical decisions
├── data-model.md        # Phase 1 - User entity schema
├── quickstart.md        # Phase 1 - Setup and test guide
├── contracts/           # Phase 1 - OpenAPI specs
│   └── auth-api.yaml    # Auth endpoint contracts
└── tasks.md             # Phase 2 - Implementation tasks (next step)
```

### Source Code (Phase 2 Auth Rebuild)

```text
todo-web-app/backend/
├── src/
│   ├── api/
│   │   └── auth.py          # Auth routes (register, login, me)
│   ├── models/
│   │   └── user.py          # SQLAlchemy User model
│   ├── schemas/
│   │   └── auth.py          # Pydantic request/response models
│   ├── services/
│   │   └── auth_service.py  # Business logic
│   ├── utils/
│   │   ├── password.py      # Passlib bcrypt hashing
│   │   └── jwt.py           # JWT creation/verification
│   ├── database.py          # SQLAlchemy engine + session
│   ├── config.py            # Settings from environment
│   └── main.py              # FastAPI app
├── alembic/                  # Database migrations
├── tests/
│   └── test_auth.py         # Auth endpoint tests
├── .env.example             # Environment template
└── requirements.txt         # Python dependencies

todo-web-app/frontend/
├── src/
│   ├── app/
│   │   ├── (auth)/
│   │   │   ├── login/page.tsx    # Login page
│   │   │   └── register/page.tsx # Register page
│   │   └── layout.tsx
│   ├── lib/
│   │   └── auth.ts              # Token storage utility
│   └── services/
│       └── api.ts               # API client with auth header
└── package.json
```

**Structure Decision**: Web application structure with separate frontend/backend directories. Phase 2 focuses on backend auth rebuild; frontend auth UI is secondary deliverable.

## Phase 2 Auth Implementation Overview

### Backend Components

1. **User Model** (`models/user.py`)
   - Integer primary key
   - Email (unique, indexed, lowercase)
   - Hashed password (bcrypt)
   - Created timestamp

2. **Password Utility** (`utils/password.py`)
   - `hash_password()` - Passlib CryptContext with bcrypt
   - `verify_password()` - Compare plain vs hashed

3. **JWT Utility** (`utils/jwt.py`)
   - `create_access_token()` - HS256, 60min expiry
   - `verify_token()` - Decode and validate
   - `get_current_user()` - FastAPI dependency

4. **Auth Routes** (`api/auth.py`)
   - `POST /api/auth/register` → 201 + token
   - `POST /api/auth/login` → 200 + token
   - `GET /api/auth/me` → 200 + user info

5. **Error Handling**
   - 400: Validation errors (password too short)
   - 401: Invalid credentials
   - 409: Email already registered
   - No generic `except Exception`

### Frontend Components

1. **Auth Utility** (`lib/auth.ts`)
   - `setToken()`, `getToken()`, `removeToken()`
   - localStorage-based storage

2. **API Client** (`services/api.ts`)
   - Automatic Bearer token attachment
   - Error handling

3. **Auth Pages**
   - `/register` - Email + password form
   - `/login` - Email + password form
   - Redirect to dashboard on success

## API Contract Summary

| Endpoint | Method | Auth | Success | Error Codes |
|----------|--------|------|---------|-------------|
| `/api/auth/register` | POST | No | 201 | 400, 409 |
| `/api/auth/login` | POST | No | 200 | 401 |
| `/api/auth/me` | GET | Yes | 200 | 401 |

See `contracts/auth-api.yaml` for full OpenAPI specification.

## Complexity Tracking

> No violations - standard web application architecture with clear separation of concerns.

| Aspect | Complexity Level | Justification |
|--------|-----------------|---------------|
| Architecture | Low | Single-service, 3 endpoints |
| Data Model | Low | 1 entity with 4 fields |
| Security | Medium | bcrypt + JWT (industry standard) |
| Error Handling | Low | Explicit HTTP exceptions |

## Next Steps

1. Run `/sp.tasks` to generate implementation tasks
2. Implement backend auth (register, login, me)
3. Test with curl commands from quickstart.md
4. Implement frontend auth UI
5. End-to-end test: register → login → me

## References

- [research.md](./research.md) - Technical decisions
- [data-model.md](./data-model.md) - User entity schema
- [contracts/auth-api.yaml](./contracts/auth-api.yaml) - OpenAPI spec
- [quickstart.md](./quickstart.md) - Setup and test guide
